<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Multiflex: global-agent</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Multiflex
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">global-agent </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a href="https://gitspo.com/mentions/gajus/global-agent"><img src="https://gitspo.com/badges/mentions/gajus/global-agent?style=flat-square" alt="GitSpo Mentions" class="inline"/></a> <a href="https://travis-ci.org/gajus/global-agent"><img src="http://img.shields.io/travis/gajus/global-agent/master.svg?style=flat-square" alt="Travis build status" style="pointer-events: none;" class="inline"/></a> <a href="https://coveralls.io/github/gajus/global-agent"><img src="https://img.shields.io/coveralls/gajus/global-agent.svg?style=flat-square" alt="Coveralls" style="pointer-events: none;" class="inline"/></a> <a href="https://www.npmjs.org/package/global-agent"><img src="http://img.shields.io/npm/v/global-agent.svg?style=flat-square" alt="NPM version" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/gajus/canonical"><img src="https://img.shields.io/badge/code%20style-canonical-blue.svg?style=flat-square" alt="Canonical Code Style" style="pointer-events: none;" class="inline"/></a> <a href="https://twitter.com/kuizinas"><img src="https://img.shields.io/twitter/follow/kuizinas.svg?style=social&amp;label=Follow" alt="Twitter Follow" style="pointer-events: none;" class="inline"/></a></p>
<p >Global HTTP/HTTPS proxy configurable using environment variables.</p>
<ul>
<li>Usage<ul>
<li>Setup proxy using `global-agent/bootstrap`</li>
<li>Setup proxy using `bootstrap` routine</li>
<li>Runtime configuration</li>
<li>Exclude URLs</li>
<li>Enable logging</li>
</ul>
</li>
<li>API<ul>
<li>`createGlobalProxyAgent`</li>
<li>Environment variables</li>
<li>`global.GLOBAL_AGENT`</li>
</ul>
</li>
<li>Supported libraries</li>
<li>FAQ<ul>
<li>What is the reason `global-agent` overrides explicitly configured HTTP(S) agent?</li>
<li>What is the reason `global-agent/bootstrap` does not use `HTTP_PROXY`?</li>
<li>What is the difference from `global-tunnel` and `tunnel`?</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md1636"></a>
Usage</h1>
<h2><a class="anchor" id="autotoc_md1637"></a>
Setup proxy using &lt;tt&gt;global-agent/bootstrap&lt;/tt&gt;</h2>
<p >To configure HTTP proxy:</p>
<ol type="1">
<li>Import <code>global-agent/bootstrap</code>.</li>
</ol>
<ol type="1">
<li>Export HTTP proxy address as <code>GLOBAL_AGENT_HTTP_PROXY</code> environment variable.</li>
</ol>
<p >Code:</p>
<div class="fragment"><div class="line">import &#39;global-agent/bootstrap&#39;;</div>
<div class="line"> </div>
<div class="line">// or:</div>
<div class="line">// import {bootstrap} from &#39;global-agent&#39;;</div>
<div class="line">// bootstrap();</div>
</div><!-- fragment --><p >Bash:</p>
<div class="fragment"><div class="line">$ export GLOBAL_AGENT_HTTP_PROXY=http://127.0.0.1:8080</div>
</div><!-- fragment --><p >Alternatively, you can preload module using Node.js <code>--require, -r</code> configuration, e.g.</p>
<div class="fragment"><div class="line">$ export GLOBAL_AGENT_HTTP_PROXY=http://127.0.0.1:8080</div>
<div class="line">$ node -r &#39;global-agent/bootstrap&#39; your-script.js</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1638"></a>
Setup proxy using &lt;tt&gt;bootstrap&lt;/tt&gt; routine</h2>
<p >Instead of importing a self-initialising script with side-effects as demonstrated in the setup proxy using `global-agent/bootstrap` documentation, you can import <code>bootstrap</code> routine and explicitly evaluate the bootstrap logic, e.g.</p>
<div class="fragment"><div class="line">import {</div>
<div class="line">  bootstrap</div>
<div class="line">} from &#39;global-agent&#39;;</div>
<div class="line"> </div>
<div class="line">bootstrap();</div>
</div><!-- fragment --><p >This is useful if you need to conditionally bootstrap <code>global-agent</code>, e.g.</p>
<div class="fragment"><div class="line">import {</div>
<div class="line">  bootstrap</div>
<div class="line">} from &#39;global-agent&#39;;</div>
<div class="line">import globalTunnel from &#39;global-tunnel-ng&#39;;</div>
<div class="line"> </div>
<div class="line">const MAJOR_NODEJS_VERSION = parseInt(process.version.slice(1).split(&#39;.&#39;)[0], 10);</div>
<div class="line"> </div>
<div class="line">if (MAJOR_NODEJS_VERSION &gt;= 10) {</div>
<div class="line">  // `global-agent` works with Node.js v10 and above.</div>
<div class="line">  bootstrap();</div>
<div class="line">} else {</div>
<div class="line">  // `global-tunnel-ng` works only with Node.js v10 and below.</div>
<div class="line">  globalTunnel.initialize();</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1639"></a>
Setup proxy using &lt;tt&gt;createGlobalProxyAgent&lt;/tt&gt;</h2>
<p >If you do not want to use <code>global.GLOBAL_AGENT</code> variable, then you can use <code>createGlobalProxyAgent</code> to instantiate a controlled instance of <code>global-agent</code>, e.g.</p>
<div class="fragment"><div class="line">import {</div>
<div class="line">  createGlobalProxyAgent</div>
<div class="line">} from &#39;global-agent&#39;;</div>
<div class="line"> </div>
<div class="line">const globalProxyAgent = createGlobalProxyAgent();</div>
</div><!-- fragment --><p >Unlike <code>bootstrap</code> routine, <code>createGlobalProxyAgent</code> factory does not create <code>global.GLOBAL_AGENT</code> variable and does not guard against multiple initializations of <code>global-agent</code>. The result object of <code>createGlobalProxyAgent</code> is equivalent to <code>global.GLOBAL_AGENT</code>.</p>
<h2><a class="anchor" id="autotoc_md1640"></a>
Runtime configuration</h2>
<p ><code>global-agent/bootstrap</code> script copies <code>process.env.GLOBAL_AGENT_HTTP_PROXY</code> value to <code>global.GLOBAL_AGENT.HTTP_PROXY</code> and continues to use the latter variable.</p>
<p >You can override the <code>global.GLOBAL_AGENT.HTTP_PROXY</code> value at runtime to change proxy behaviour, e.g.</p>
<div class="fragment"><div class="line">http.get(&#39;http://127.0.0.1:8000&#39;);</div>
<div class="line"> </div>
<div class="line">global.GLOBAL_AGENT.HTTP_PROXY = &#39;http://127.0.0.1:8001&#39;;</div>
<div class="line"> </div>
<div class="line">http.get(&#39;http://127.0.0.1:8000&#39;);</div>
<div class="line"> </div>
<div class="line">global.GLOBAL_AGENT.HTTP_PROXY = &#39;http://127.0.0.1:8002&#39;;</div>
</div><!-- fragment --><p >The first HTTP request is going to use <a href="http://127.0.0.1:8001">http://127.0.0.1:8001</a> proxy and the secord request is going to use <a href="http://127.0.0.1:8002">http://127.0.0.1:8002</a>.</p>
<p >All <code>global-agent</code> configuration is available under <code>global.GLOBAL_AGENT</code> namespace.</p>
<h2><a class="anchor" id="autotoc_md1641"></a>
Exclude URLs</h2>
<p >The <code>GLOBAL_AGENT_NO_PROXY</code> environment variable specifies a pattern of URLs that should be excluded from proxying. <code>GLOBAL_AGENT_NO_PROXY</code> value is a comma-separated list of domain names. Asterisks can be used as wildcards, e.g.</p>
<div class="fragment"><div class="line">export GLOBAL_AGENT_NO_PROXY=&#39;*.foo.com,baz.com&#39;</div>
</div><!-- fragment --><p >says to contact all machines with the 'foo.com' TLD and 'baz.com' domains directly.</p>
<h2><a class="anchor" id="autotoc_md1642"></a>
Separate proxy for HTTPS</h2>
<p >The environment variable <code>GLOBAL_AGENT_HTTPS_PROXY</code> can be set to specify a separate proxy for HTTPS requests. When this variable is not set <code>GLOBAL_AGENT_HTTP_PROXY</code> is used for both HTTP and HTTPS requests.</p>
<h2><a class="anchor" id="autotoc_md1643"></a>
Enable logging</h2>
<p ><code>global-agent</code> is using <a href="https://www.npmjs.com/package/roarr"><code>roarr</code></a> logger to log HTTP requests and response (HTTP status code and headers), e.g.</p>
<div class="fragment"><div class="line">{&quot;context&quot;:{&quot;program&quot;:&quot;global-agent&quot;,&quot;namespace&quot;:&quot;Agent&quot;,&quot;logLevel&quot;:10,&quot;destination&quot;:&quot;http://gajus.com&quot;,&quot;proxy&quot;:&quot;http://127.0.0.1:8076&quot;},&quot;message&quot;:&quot;proxying request&quot;,&quot;sequence&quot;:1,&quot;time&quot;:1556269669663,&quot;version&quot;:&quot;1.0.0&quot;}</div>
<div class="line">{&quot;context&quot;:{&quot;program&quot;:&quot;global-agent&quot;,&quot;namespace&quot;:&quot;Agent&quot;,&quot;logLevel&quot;:10,&quot;headers&quot;:{&quot;content-type&quot;:&quot;text/plain&quot;,&quot;content-length&quot;:&quot;2&quot;,&quot;date&quot;:&quot;Fri, 26 Apr 2019 12:07:50 GMT&quot;,&quot;connection&quot;:&quot;close&quot;},&quot;requestId&quot;:6,&quot;statusCode&quot;:200},&quot;message&quot;:&quot;proxying response&quot;,&quot;sequence&quot;:2,&quot;time&quot;:1557133856955,&quot;version&quot;:&quot;1.0.0&quot;}</div>
</div><!-- fragment --><p >Export <code>ROARR_LOG=true</code> environment variable to enable log printing to stdout.</p>
<p >Use <a href="https://github.com/gajus/roarr-cli"><code>roarr-cli</code></a> program to pretty-print the logs.</p>
<h1><a class="anchor" id="autotoc_md1644"></a>
API</h1>
<h2><a class="anchor" id="autotoc_md1645"></a>
&lt;tt&gt;createGlobalProxyAgent&lt;/tt&gt;</h2>
<div class="fragment"><div class="line">/**</div>
<div class="line"> * @property environmentVariableNamespace Defines namespace of `HTTP_PROXY`, `HTTPS_PROXY` and `NO_PROXY` environment variables. (Default: `GLOBAL_AGENT_`)</div>
<div class="line"> * @property forceGlobalAgent Forces to use `global-agent` HTTP(S) agent even when request was explicitly constructed with another agent. (Default: `true`)</div>
<div class="line"> * @property socketConnectionTimeout Destroys socket if connection is not established within the timeout. (Default: `60000`)</div>
<div class="line"> */</div>
<div class="line">type ProxyAgentConfigurationInputType = {|</div>
<div class="line">  +environmentVariableNamespace?: string,</div>
<div class="line">  +forceGlobalAgent?: boolean,</div>
<div class="line">  +socketConnectionTimeout?: number,</div>
<div class="line">|};</div>
<div class="line"> </div>
<div class="line">(configurationInput: ProxyAgentConfigurationInputType) =&gt; ProxyAgentConfigurationType;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1646"></a>
Environment variables</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Description   </th><th class="markdownTableHeadNone">Default    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>GLOBAL_AGENT_ENVIRONMENT_VARIABLE_NAMESPACE</code>   </td><td class="markdownTableBodyNone">Defines namespace of <code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code> and <code>NO_PROXY</code> environment variables.   </td><td class="markdownTableBodyNone"><code>GLOBAL_AGENT_</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>GLOBAL_AGENT_FORCE_GLOBAL_AGENT</code>   </td><td class="markdownTableBodyNone">Forces to use <code>global-agent</code> HTTP(S) agent even when request was explicitly constructed with another agent.   </td><td class="markdownTableBodyNone"><code>true</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>GLOBAL_AGENT_SOCKET_CONNECTION_TIMEOUT</code>   </td><td class="markdownTableBodyNone">Destroys socket if connection is not established within the timeout.   </td><td class="markdownTableBodyNone"><code>60000</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>${NAMESPACE}_HTTP_PROXY</code>   </td><td class="markdownTableBodyNone">Sets the initial proxy controller HTTP_PROXY value.   </td><td class="markdownTableBodyNone">N/A    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>${NAMESPACE}_HTTPS_PROXY</code>   </td><td class="markdownTableBodyNone">Sets the initial proxy controller HTTPS_PROXY value.   </td><td class="markdownTableBodyNone">N/A    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>${NAMESPACE}_NO_PROXY</code>   </td><td class="markdownTableBodyNone">Sets the initial proxy controller NO_PROXY value.   </td><td class="markdownTableBodyNone">N/A   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md1647"></a>
&lt;tt&gt;global.GLOBAL_AGENT&lt;/tt&gt;</h2>
<p ><code>global.GLOBAL_AGENT</code> is initialized by <code>bootstrap</code> routine.</p>
<p ><code>global.GLOBAL_AGENT</code> has the following properties:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Description   </th><th class="markdownTableHeadNone">Configurable    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>HTTP_PROXY</code>   </td><td class="markdownTableBodyNone">Yes   </td><td class="markdownTableBodyNone">Sets HTTP proxy to use.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>HTTPS_PROXY</code>   </td><td class="markdownTableBodyNone">Yes   </td><td class="markdownTableBodyNone">Sets a distinct proxy to use for HTTPS requests.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>NO_PROXY</code>   </td><td class="markdownTableBodyNone">Yes   </td><td class="markdownTableBodyNone">Specifies a pattern of URLs that should be excluded from proxying. See Exclude URLs.   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md1648"></a>
Supported libraries</h1>
<p ><code>global-agent</code> works with all libraries that internally use <a href="https://nodejs.org/api/http.html#http_http_request_options_callback"><code>http.request</code></a>.</p>
<p ><code>global-agent</code> has been tested to work with:</p>
<ul>
<li><a href="https://www.npmjs.com/package/got"><code>got</code></a></li>
<li><a href="https://www.npmjs.com/package/axios"><code>axios</code></a></li>
<li><a href="https://www.npmjs.com/package/axios"><code>request</code></a></li>
</ul>
<h1><a class="anchor" id="autotoc_md1649"></a>
FAQ</h1>
<h2><a class="anchor" id="autotoc_md1650"></a>
What is the reason &lt;tt&gt;global-agent&lt;/tt&gt; overrides explicitly configured HTTP(S) agent?</h2>
<p >By default, <code>global-agent</code> overrides <a href="https://nodejs.org/api/http.html#http_http_request_options_callback"><code>agent</code> property</a> of any HTTP request, even if <code>agent</code> property was explicitly set when constructing a HTTP request. This behaviour allows to intercept requests of libraries that use a custom instance of an agent per default (e.g. Stripe SDK <a href="https://github.com/stripe/stripe-node/blob/e542902dd8fbe591fe3c3ce07a7e89d1d60e4cf7/lib/StripeResource.js#L11-L12">uses an <code>http(s).globalAgent</code> instance pre-configured with <code>keepAlive: true</code></a>).</p>
<p >This behaviour can be disabled with <code>GLOBAL_AGENT_FORCE_GLOBAL_AGENT=false</code> environment variable. When disabled, then <code>global-agent</code> will only set <code>agent</code> property when it is not already defined or if <code>agent</code> is an instance of <code>http(s).globalAgent</code>.</p>
<h2><a class="anchor" id="autotoc_md1651"></a>
What is the reason &lt;tt&gt;global-agent/bootstrap&lt;/tt&gt; does not use &lt;tt&gt;HTTP_PROXY&lt;/tt&gt;?</h2>
<p >Some libraries (e.g. <a href="https://npmjs.org/package/request"><code>request</code></a>) change their behaviour when <code>HTTP_PROXY</code> environment variable is present. Using a namespaced environment variable prevents conflicting library behaviour.</p>
<p >You can override this behaviour by configuring <code>GLOBAL_AGENT_ENVIRONMENT_VARIABLE_NAMESPACE</code> variable, e.g.</p>
<div class="fragment"><div class="line">$ export GLOBAL_AGENT_ENVIRONMENT_VARIABLE_NAMESPACE=</div>
</div><!-- fragment --><p >Now script initialized using <code>global-agent/bootstrap</code> will use <code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code> and <code>NO_PROXY</code> environment variables.</p>
<h2><a class="anchor" id="autotoc_md1652"></a>
What is the difference from &lt;tt&gt;global-tunnel&lt;/tt&gt; and &lt;tt&gt;tunnel&lt;/tt&gt;?</h2>
<p ><a href="https://github.com/salesforce/global-tunnel"><code>global-tunnel</code></a> (including <a href="https://github.com/np-maintain/global-tunnel"><code>global-tunnel-ng</code></a> and <a href="https://npmjs.com/package/tunnel"><code>tunnel</code></a>) are designed to support legacy Node.js versions. They use various <a href="https://github.com/koichik/node-tunnel/blob/5fb2fb424788597146b7be6729006cad1cf9e9a8/lib/tunnel.js#L134-L144">workarounds</a> and rely on <a href="https://github.com/np-maintain/global-tunnel/blob/51413dcf0534252b5049ec213105c7063ccc6367/index.js#L302-L338">monkey-patching <code>http.request</code>, <code>http.get</code>, <code>https.request</code> and <code>https.get</code> methods</a>.</p>
<p >In contrast, <code>global-agent</code> supports Node.js v10 and above, and does not implements workarounds for the older Node.js versions. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
